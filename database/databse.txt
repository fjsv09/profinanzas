-- Tabla de usuarios (complemento a auth.users de Supabase)
CREATE TABLE usuarios (
    id UUID PRIMARY KEY REFERENCES auth.users(id),
    email TEXT NOT NULL UNIQUE,
    nombre TEXT NOT NULL,
    apellido TEXT NOT NULL,
    rol TEXT NOT NULL CHECK (rol IN ('admin_sistema', 'administrador', 'supervisor', 'asesor')),
    activo BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Tabla de clientes
CREATE TABLE clientes (
    id SERIAL PRIMARY KEY,
    dni TEXT NOT NULL UNIQUE,
    nombre TEXT NOT NULL,
    apellido TEXT NOT NULL,
    telefono TEXT NOT NULL,
    direccion TEXT NOT NULL,
    referencias TEXT,
    historial_pagos TEXT DEFAULT 'Nuevo' CHECK (historial_pagos IN ('Nuevo', 'Bueno', 'Regular', 'Malo')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_by UUID REFERENCES usuarios(id)
);

-- Tabla de préstamos
CREATE TABLE prestamos (
    id SERIAL PRIMARY KEY,
    cliente_id INTEGER NOT NULL REFERENCES clientes(id),
    monto DECIMAL(10, 2) NOT NULL,
    interes DECIMAL(5, 2) NOT NULL,
    monto_total DECIMAL(10, 2) NOT NULL,
    frecuencia_pago TEXT NOT NULL CHECK (frecuencia_pago IN ('diario', 'semanal', 'quincenal', 'mensual')),
    total_cuotas INTEGER NOT NULL,
    cuotas_pagadas INTEGER DEFAULT 0,
    estado TEXT NOT NULL DEFAULT 'activo' CHECK (estado IN ('activo', 'completado', 'atrasado')),
    fecha_inicio TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_by UUID REFERENCES usuarios(id)
);

-- Tabla de pagos
CREATE TABLE pagos (
    id SERIAL PRIMARY KEY,
    prestamo_id INTEGER NOT NULL REFERENCES prestamos(id),
    monto DECIMAL(10, 2) NOT NULL,
    fecha_pago TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    metodo_pago TEXT NOT NULL CHECK (metodo_pago IN ('efectivo', 'yape', 'transferencia', 'otro')),
    comentario TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_by UUID REFERENCES usuarios(id)
);

-- Tabla de transacciones financieras
CREATE TABLE transacciones (
    id SERIAL PRIMARY KEY,
    tipo TEXT NOT NULL CHECK (tipo IN ('ingreso', 'egreso')),
    monto DECIMAL(10, 2) NOT NULL,
    categoria TEXT NOT NULL,
    descripcion TEXT,
    cuenta TEXT NOT NULL CHECK (cuenta IN ('caja', 'banco', 'yape', 'otro')),
    fecha TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_by UUID REFERENCES usuarios(id)
);

-- Tabla de metas
CREATE TABLE metas (
    id SERIAL PRIMARY KEY,
    asesor_id UUID NOT NULL REFERENCES usuarios(id),
    periodo TEXT NOT NULL, -- Formato YYYY-MM
    meta_clientes INTEGER NOT NULL DEFAULT 0,
    meta_cobranza DECIMAL(10, 2) NOT NULL DEFAULT 0,
    meta_morosidad DECIMAL(5, 2) NOT NULL DEFAULT 0, -- Porcentaje
    meta_cartera DECIMAL(10, 2) NOT NULL DEFAULT 0,
    clientes_captados INTEGER DEFAULT 0,
    cobranza_realizada DECIMAL(10, 2) DEFAULT 0,
    morosidad_actual DECIMAL(5, 2) DEFAULT 0,
    cartera_actual DECIMAL(10, 2) DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_by UUID REFERENCES usuarios(id),
    UNIQUE (asesor_id, periodo)
);

-- Tabla de gastos diarios de asesores
CREATE TABLE gastos_asesores (
    id SERIAL PRIMARY KEY,
    asesor_id UUID NOT NULL REFERENCES usuarios(id),
    fecha DATE NOT NULL DEFAULT CURRENT_DATE,
    tipo TEXT NOT NULL CHECK (tipo IN ('transporte', 'papeleria', 'imprevisto', 'otro')),
    monto DECIMAL(10, 2) NOT NULL,
    descripcion TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Tabla para cuadre de caja
CREATE TABLE cuadre_caja (
    id SERIAL PRIMARY KEY,
    asesor_id UUID NOT NULL REFERENCES usuarios(id),
    fecha DATE NOT NULL DEFAULT CURRENT_DATE,
    monto_efectivo DECIMAL(10, 2) NOT NULL DEFAULT 0,
    monto_yape DECIMAL(10, 2) NOT NULL DEFAULT 0,
    monto_transferencia DECIMAL(10, 2) NOT NULL DEFAULT 0,
    monto_otro DECIMAL(10, 2) NOT NULL DEFAULT 0,
    monto_total DECIMAL(10, 2) NOT NULL DEFAULT 0,
    estado TEXT NOT NULL DEFAULT 'pendiente' CHECK (estado IN ('pendiente', 'aprobado', 'rechazado')),
    comentarios TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    aprobado_por UUID REFERENCES usuarios(id),
    UNIQUE (asesor_id, fecha)
);

-- Tabla para renovaciones de préstamos
CREATE TABLE renovaciones (
    id SERIAL PRIMARY KEY,
    prestamo_anterior_id INTEGER NOT NULL REFERENCES prestamos(id),
    prestamo_nuevo_id INTEGER NOT NULL REFERENCES prestamos(id),
    motivo TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_by UUID REFERENCES usuarios(id)
);

-- Funciones y Triggers para actualización automática

-- Función para actualizar el campo updated_at
CREATE OR REPLACE FUNCTION update_modified_column()
RETURNS TRIGGER AS $$
BEGIN
   NEW.updated_at = NOW();
   RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger para actualizar updated_at en usuarios
CREATE TRIGGER update_usuarios_modtime
BEFORE UPDATE ON usuarios
FOR EACH ROW
EXECUTE FUNCTION update_modified_column();

-- Trigger para actualizar updated_at en clientes
CREATE TRIGGER update_clientes_modtime
BEFORE UPDATE ON clientes
FOR EACH ROW
EXECUTE FUNCTION update_modified_column();

-- Trigger para actualizar updated_at en prestamos
CREATE TRIGGER update_prestamos_modtime
BEFORE UPDATE ON prestamos
FOR EACH ROW
EXECUTE FUNCTION update_modified_column();

-- Trigger para actualizar updated_at en metas
CREATE TRIGGER update_metas_modtime
BEFORE UPDATE ON metas
FOR EACH ROW
EXECUTE FUNCTION update_modified_column();

-- Trigger para actualizar updated_at en gastos_asesores
CREATE TRIGGER update_gastos_asesores_modtime
BEFORE UPDATE ON gastos_asesores
FOR EACH ROW
EXECUTE FUNCTION update_modified_column();

-- Trigger para actualizar updated_at en cuadre_caja
CREATE TRIGGER update_cuadre_caja_modtime
BEFORE UPDATE ON cuadre_caja
FOR EACH ROW
EXECUTE FUNCTION update_modified_column();

-- Función para actualizar cuotas_pagadas en préstamos cuando se registra un pago
CREATE OR REPLACE FUNCTION update_prestamo_after_pago()
RETURNS TRIGGER AS $$
DECLARE
    prestamo_record RECORD;
    cuota_valor DECIMAL;
BEGIN
    -- Obtener información del préstamo
    SELECT * INTO prestamo_record FROM prestamos WHERE id = NEW.prestamo_id;
    
    -- Calcula el valor de una cuota
    cuota_valor := prestamo_record.monto_total / prestamo_record.total_cuotas;
    
    -- Incrementar cuotas_pagadas basado en el monto del pago
    UPDATE prestamos
    SET 
        cuotas_pagadas = LEAST(total_cuotas, cuotas_pagadas + (NEW.monto / cuota_valor)),
        updated_at = NOW()
    WHERE id = NEW.prestamo_id;
    
    -- Si se completan todas las cuotas, actualizar estado a 'completado'
    UPDATE prestamos
    SET estado = 'completado'
    WHERE id = NEW.prestamo_id AND cuotas_pagadas >= total_cuotas;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger para actualizar el préstamo cuando se registra un pago
CREATE TRIGGER update_prestamo_cuotas
AFTER INSERT ON pagos
FOR EACH ROW
EXECUTE FUNCTION update_prestamo_after_pago();


-- Añadir campos para el sistema de aprobación de préstamos
ALTER TABLE prestamos 
ADD COLUMN estado_aprobacion TEXT DEFAULT 'pendiente' CHECK (estado_aprobacion IN ('pendiente', 'aprobado', 'rechazado')),
ADD COLUMN aprobado_por UUID REFERENCES usuarios(id),
ADD COLUMN fecha_aprobacion TIMESTAMP WITH TIME ZONE,
ADD COLUMN comentarios_aprobacion TEXT,
ADD COLUMN fecha_solicitud TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
ADD COLUMN tipo TEXT DEFAULT 'nuevo' CHECK (tipo IN ('nuevo', 'renovacion')),
ADD COLUMN prestamo_anterior_id INTEGER REFERENCES prestamos(id);




-- Agregar campo supervisor_id a la tabla usuarios para la jerarquía de supervisión
ALTER TABLE usuarios 
ADD COLUMN supervisor_id UUID REFERENCES usuarios(id),
-- Agregar esta columna para almacenar información adicional sobre el supervisor
ADD COLUMN supervisor_desde TIMESTAMP WITH TIME ZONE;

-- Agregar campo asesor_id a la tabla clientes para la asignación de clientes a asesores
ALTER TABLE clientes 
ADD COLUMN asesor_id UUID NOT NULL REFERENCES usuarios(id),
-- Agregar un campo para almacenar cuándo fue asignado el cliente al asesor
ADD COLUMN asignado_desde TIMESTAMP WITH TIME ZONE DEFAULT NOW();

-- Crear un índice para mejorar el rendimiento de las consultas por asesor_id en clientes
CREATE INDEX idx_clientes_asesor_id ON clientes(asesor_id);

-- Crear un índice para mejorar el rendimiento de las consultas por supervisor_id en usuarios
CREATE INDEX idx_usuarios_supervisor_id ON usuarios(supervisor_id);